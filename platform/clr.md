# Среда CLR

Ообщеязыковая среда выполнения (CLR) управляет выполнением кода на [платформе .NET](./index.md) (читается дот нет). Главные ее задачи - автоматическое обнаружение, загрузка и управление объектами .NET. Низкоуровневые задачи - управление памятью, обслуживание приложений, координирование потоков и обеспечивание безопасности.

Исполняющая среда CLR можно понимать как коллекцию служб, которые требуются для выполнения скомпилированной еденицы кода. Главный механизм представлен библиотекой mscoree.dll в каталоге %SystemRoot%\system32 (общий механизм выполнения исполняемого кода Common Object Runtime Execution Engine). 

От ссылки на сборку автоматически загружается этот механизм и он сам уже загружает требуемую сборку в память, определяет местоположение сборки, загружает требуемые типы по метаданным, размещает типы в памяти, компилирует общий промежуточный код CIL в специфичные для данной платформы инструкции, проверку безапасности и затем запускает на выполнение созданный код. Плюс среда осущуствляет взаимодействие с типами из обширной библиотеки базовых классов, главной сборкой является mscorlib.dll. При постоении решений .NET доступ к этой сборке осуществляется автоматически. (Троелсен C# 7 8-е изд. 67 стр.).

Результатом компиляции кода C# является не исполняемый код в файле, а псевдокод в файле, назваесый общий промежуточный язык (СIL - Commmon Intermediate Language ). Этот код определяет набор переносимых инструкций, не зависяций от процессора - переносимый язык ассемблера. Это совсем не байт-код Java. 

Части сборки:

- Заголовок PE32 или PE32+. Файл с заголовком в формате PE32 может выполняться в 32- и 64-разрядной версиях Windows, а с заголовком PE32+ — только в 64-разрядной. Заголовок обозначает тип файла: GUI, CUI или DLL, он также имеет временную метку, показывающую, когда файл был собран. В модулях, содержащих машинный код, этот заголовок содержит сведения о машинном коде.

- Заголовок CLR. Содержит информацию (интерпретируемую CLR и утилитами), которая превращает этот модуль или сборку в управляемый или управляемую. Заголовок включает нужную версию CLR, метку метаданных MethodDef точки входа в правляемый модуль (метод Main), а также месторасположение/размер метаданных модуля, ресурсов и пр.

- Метаданные. Каждый управляемый модуль содержит таблицы метаданных. Есть два основных вида таблиц — это таблицы, описывающие типы данных и их члены,  пределенные в исходном коде этой сборки, и таблицы, описывающие типы данных и их члены, на которые имеются ссылки из исходного кода.

- Код CIL. Код на общем промежуточном языке, создаваемый компилятором при компиляции исходного кода. Впоследствии CLR компилирует CIL в машинные команды. (Рихтер CLR C# 4-е изд 30 стр)

>Задачей среды выполнения CLR является преобразовать промежуточный код в исполняемый на ходу запуска экзешника программы. А это значит что программа будет работать там, где установлена среда .NET Framework.

Код преобразует из одного вида в другой специальный JIT (точно в срок - jit on time)-компилятор. При запуске экзешника исполняемого файла среда CLR активирует JIT компилятор и он уже преобразует код CIL в машинный код, ориентированный на конктектную процессорную архитектуру, например x86, x64 или ARM. Программа как бы выполняется как собственный код, при это обеспечивается переносимость превдокода CIL. (Шилдт C# 4 12 стр.).

Пространство имен - группа семантически родственных типов, которые содержатся в одной или нескольких связанных друг с другом сбороках. Любой язык, ориентированный на исполняющую среду CLR .NET должен использовать теже самые пространства и теже самые типы, что и другие языки.

С точки зрения исполняющей среды .NET System.Console - одиночный класс, не в пространстве имен System. После указания на пространства имен (и установки ссылки на сборки, где они определены) можно создавать экземляры типов, которые в них содержатся.

При компиляции программы из C# в CIL компилятором также производятся метаданные, служащие для описания данных, используемых в программе, и служат для простого взаимодействия одного кода с другим. Эти данные помещаются в тот же самый файл что и промежуточный [управляемый код CIL](./managed.md).

Среда CLR работает на платформе .NET Framework взаимодействуя с библиотекой базовых классов и включает в свой состав: [общую систему типов CTS](./cts.md) и [общеязыковую спецификацию CLS](./cls.md).
