# Валидация

Приложениям необходимо проверять пользовательский ввод и обеспечивать обратную связь с пользователем, если введенные им данные оказываются некорректными. Проверка достоверности происходит, когда привязка данных пытается обновить источник данных. Если правило проверки достоверности нарушается, то в игру вступает класс Validation.

Класс Validation применяется для проверки достоверности и предоставляет методы и свойства для отображения результата проверки. 

После внесения изменений индексатор вызывается на модели каждый раз при PropertyChanged. Если индексатор возвращает отличное от string.Empty, тогда в свойстве этого элемента присутствует ошибка, из-за чего каждый элемент управления, привязанный к свойству специфического экземпляра класса, считается содержащим ошибку. Свойство HasError устанавливается в true и показывается декоратор ErrorTemplate для элементов управления.

Технологии XAML поддерживают несколько механизмов для встраивания логики проверки достоверности внутрь приложения:

- Уведомление по исключениям

- Интерфейс IDataErrorlnfo

- Интерфейс INotifyDataErrorlnfo

- Использование аннотаций данных в WPF

## Уведомление по исключениям

В инфраструктуре WPF исключения привязки (по умолчанию) не распространяются до пользователя как собственно исключения. Тем не менее, они указываются визуально с применением декоратора.

Визуально исключение представляется с помощью тонкого прямоугольника красного цвета вокруг элемента управления. Стандартный внешний вид говорит о наличии ошибки, нет никакого указания на то, что именно пошло не так. Шаблон отображения ошибки в свойстве ErrorTemplate является полностью настраиваемым.

## Интерфейс IDataErrorlnfo

Интерфейс IDataErrorInfo дает механизм для добавления специальной проверки достоверности в классы моделей. Интерфейс добавляется в классы моделей, а код проверки помещается внутрь классов моделей. Данный интерфейс добавляется прямо в классы моделей (или моделей представлений), а код проверки помещается внутрь классов моделей (предпочтительно в частичные классы).

Интерфейс:

```csharp
public interface IDataErrorlnfo
{
    string this[string columnName] { get; }
    string Error { get; }
}
```

Чтобы привязанный элемент управления мог работать с интерфейсом IDataErrorInfo, в выражение привязки потребуется добавить ValidatesOnDataErrors.

Пример:

```csharp
...
</Grid.RowDefinitions>
<Label Grid.Column="0" Grid.Row="0" Content="Id" Margin="3"/>
<TextBox Grid.Column="1" Grid.Row="0" Margin="3" Text="{Binding Path=CarId, ValidatesOnDataErrors=True}"/>
<Label Grid.Column="0" Grid.Row="1" Content="Марка" Margin="3"/>
<TextBox Grid.Column="1" Grid.Row="1" Margin="3" Text="{Binding Path=Make, ValidatesOnDataErrors=True}"/>
...
public partial class Inventory : IDataErrorInfo
{
    private string error;
    //индексатор валидации
    public string this[string columnName]
    {
        get
        {
            switch (columnName)
            {
                case nameof(CarId):
                    break;
                case nameof(Make):
                    if (Make == "Чайка")
                    {
                        return "Слишком старая";
                    }
                    return CheckMakeAndColor();
                case nameof(Color):
                    return CheckMakeAndColor();
                case nameof(PetName):
                    break;
            }
            return string.Empty;
        }
    }
    private string CheckMakeAndColor()
    {
        if (Make == "Копейка" && Color == "Беж")
        {
            return $"{Make} не может быть цвета {Color}";
        }
        return string.Empty;
    }
    public string Error => error;
}
```

## Интерфейс INotifyDataErrorlnfo

Интерфейс INotifyDataErrorInfo построен на основе IDataErrorInfo и дает дополнительные возможности для проверки достоверности.

Интерфейс:

```csharp
public interface INotifyDataErrorlnfo
{
    bool HasErrors { get; }
    event EventHandler<DataErrorsChangedEventArgs> ErrorsChanged;
    IEnumerable GetErrors(string propertyName);
}
```

Свойство HasError используется механизмом привязки для выяснения, есть ли какие либо ошибки в свойствах экземпляра. При реализации интерфейса INotifyDataErrorInfo требуется писать гораздо больше кода. При этом используются определенные механизмы этого интерфейса для проверки на предмет ошибок - блоки set для свойств. Это делает код труднее в чтении и сопровождении.

Если метод GetErrors() вызывается со значением null или пустой строкой в параметре propertyName, то он возвращает все ошибки, существующие в экземпляре. Если методу передан параметр propertyName, тогда возвращаются только ошибки, относящиеся к конкретному свойству. Событие ErrorsChanged (подобно событиям PropertyChanged и CollectionChanged)уведомляет механизм привязки о необходимости обновления пользовательского интерфейса для текущего списка ошибок.

Пример валидации параметра с применением интерфейса INotifyDataErrorInfo для проверки достоверности:







