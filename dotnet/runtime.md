# Core Runtime

Общеязыковая среда исполнения CLR это самодостаточная высокоуровневая виртуальная машина разработанная для поддержки разнообразнейших языков программирования и взаимодействия между ними.

Для работы приложения .NET на целевой машине должен быть установлен .NET Framework, а именно CLR + BCL. BCL располагается в GAC. 

Для работы приложения .NET Core - нужен NET Core = Core CLR + Core FX (новое название для BCL). Иной способ загрузки среды выполнения (CLR). Вместо заголовка в управляемой сборке MyApp.exe в .NET Framework, в .NET Core MyApp.exe сам по себе является нативной программой загрузки Core CLR.

В .NET Core все компоненты программы, которые мы определяем на этапе компиляции, являются зависимостями приложения (включая Core CLR, JIT), которые инфраструктура .NET Core рассматривает как пакеты.

Зависимости в распакованном виде при запуске приложения должны находиться в одной из определенных директорий (папке .NET Core фреймворка — Core FX, папке приложения или любом NuGet-кеше).

## .NET Core Runtime

Для выполнения приложения на целевой должен быть установлен .NET Core Runtime (shared framework) в папку C:\Program Files\dotnet. Файлы фреймворка хранятся в папке C:\Program Files\dotnet\shared.

Можно установить несколько версий.

Состав фреймворка:

- Утилита dotnet.exe для запуска .NET Core приложения - драйвер инфраструктуры .NET Core, точка входа для запуска любых приложений и выполнения команд разработки. Является хост-процессом любог приложения - corehost.

- Runtime-компоненты устанавливаются в отдельную папку фреймворка C:\Program Files\dotnet\shared\[Framework name]\[Framework version].

- Нативная библиотека host framework resolver в папке C:\Program Files\dotnet\host\[версия]\hostfxr.dll. Максимальная версия выполняет разрешение версии фреймворка для последующего выполнения.

Для выполнения Portable-приложения необходимо запустить хост-процесс dotnet.exe и передать ему в качестве аргумента путь к управляемой сборке.

> dotnet path/to/App.dll

В папке приложения (там, где находится [AppName].dll) должен лежать файл [AppName].runtimeconfig.json. В нём указаны имя и версия фреймворка, которые должны быть использованы для выполнения Portable-приложения. Этот файл является обязательным для Portable-приложений.

## Приложение .NET Core

Состав .NET Core-приложения:

- [AppName].dll — IL-код приложения, точка входа.

- [App dependencies]*.dll — все зависимости приложения, не входящие в состав CoreFX (сборки проектов, сторонние библиотеки, FCL).

- [AppName].runtimeconfig.json — конфигурация среды выполнения, здесь указаны имя и версия .NET Core-фреймворка (runtime-компонентов). Файл является чем-то вроде MyApp.exe.config в .NET Frameowork. Эту конфигурацию можно изменять, если необходимо явно указать конкретный фреймворк.

- [AppName].deps.json — перечень всех зависимостей приложения. Не рекомендуется изменять этот файл, потому что он генерируется при компиляции. Файл не является обязательным, но если его удалить, хост-процесс при запуске не сможет проверить пути всех файлов зависимостей, и выполнение начнется на свой страх и риск.

## Процесс запуска приложения .NET Core

Запуск приложения выполняется при помощи мультплексора (muxer) из командной строки (одинаково на любой ОС).

> dotnet path\to\MyApp.dll

dotnet.exe — переименованный corehost.exe, эта программа является хост-процессом любого .NET Core-приложения, с неё начинается процесс запуска.

### [corehost] Поиск и загрузка Framework Resolver (hostfxr.dll)

На этом этапе dotnet.exe идет в папку [own directory]/host/fxr/. Для Portable-приложений эта библиотека расположена в общей папке C:\Program Files\dotnet\host\fxr\[FXR version]\hostfxr.dll. Если версий будет несколько, dotnet.exe будет всегда использовать последнюю.

После загрузки hostfxr.dll (Framework Resolver) процесс запуска переходит в рамки этой библиотеки.

### [hostfxr] Определение режима выполнения (standalone, muxer, split/FX)

Первая задача hostfxr — определить режим, в котором будет работать хост процесс и таким образом тип приложения — Portable (FDD) или Standalone (SCD). В Portable (FDD)-режиме он также определяет: это запускаемое приложение или команда SDK.

### [hostfxr] Определение .NET Core Runtime

Первым делом hostfxr определяет и загружает файлы конфигурации deps и runtimeconfig. Если ничего не переопределено в аргументах, эти файлы берутся из папки приложения.

### [hostfxr] Поиск и загрузка hostpolicy.dll

На текущем этапе всё готово для определения путей runtime-компонентов. Этой задачей занимается библиотека hostpolicy.dll, которая называется Host library.

Как только опеределена hostpolicy.dll, hostfxr загружает эту библиотеку и передает ей управление.

### [hostpolicy] Определение списка зависимостей

Библиотека hostpolicy.dll отвечает за определение абсолютных путей всех зависимостей приложения.

### [hostpolicy] Определение путей TPA, Core CLR и CLR Jit

Далее Dependency resolver составляет список абсолютных путей файлов управляемых сборок — зависимостей приложения. Этот список называется TPA (Trusted Platform Assemblies) и передается Core CLR для настройки AppDomain. Также составляется список абсолютных путей директорий, в которых находятся остальных файлы зависимостей (кроме coreclr, corejit).

Далее управление переходит к coreclr.dll.

## Заключение

- Компонентная модель .NET Core (Runtime, BCL) полностью состоит из NuGet-пакетов.

- Существует два типа развертывания — FDD и SCD. По возможности рекомендуется использовать Framework Dependent-развертывание, чтобы избежать сложностей с платформозависимыми компонентами и не поставлять лишние зависимости.

- Есть достаточно много возможностей повлиять на процесс запуска на целевой машине, и при необходимости переопределить/пропатчить файлы зависимостей, а также добавить неявные (динамически запускаемые) зависимости.

- Не рекомендуется без особых причин удалять или изменять файл Dependency manifest (*.deps.json) .

- Используя --additional-deps и --additionalprobepaths мы можем размещать runtime-компоненты в нужной нам файловой структуре.

- Используя Exec mode можно переопределить файлы конфигурации приложения.

[Источник](https://habr.com/ru/company/nix/blog/327686/)