# WPF Введение (инфраструктура, разметка, строительство)

Программисты .NET имеют единственный симметричный API-интерфейс для всех распространенных потребностей при использовании WPF для разработки графических настрольных приложений:

```csharp
Желаемая функциональность                   Технология
Построение форм с элементами управления         WPF
Поддержка двумерной графики                     WPF
Поддержка трехмерной графики                    WPF
Поддержка потокового видео                      WPF
Поддержка документов нефиксированного формата   WPF
```

Инфраструктура WPF определеяет способ отделения внешнего вида и поведения приложения с графическим пользовательским интерфейсом от программной логики. Пользовательский интерйейс пишется на языке XAML через разметку XML - "настольную разметку", с помощью инструментов Microsoft Visual Studio или Microsoft Expression Blend, затем может быть подключена к связанном файлу кода. Допустимо изменять внешний вид элемента управления только с помощью разметки. Модель WPF отличается от других тем, что визуализация графических данных происходит через API-интерфейс DirectX, а GDI не используется. Приложения WPF автоматом получают аппараткую и программную оптимизацию, могут задействовать графические службы без сложностей, присущих программированию напрямую через API DirectX.

Основные функциональные возможности WPF:

- множество диспетчеров компоновки для гибкого контроля над размещением и изменением содержимого

- расширенный механизм привязок данных для связывания содержимого с элементами пользовательского интерфейса

- встроенный механизм стилей, позволяющий определять темы приложения

- векторная графика для автоматического изменения размеров содержимого с целью соответтсвия размерам и разрешению экрана

- поддержка двухмерной и трехмерной графики, анимации, аудио и видео

- типографичкский API-интерфейс, поддерживающий документы XML, фиксированные документы, нефиксированные документы и аннотации в документах

- взаимодействие с унаследованными моделями графических пользовательских интерфейсов

## Инфраструктура

Инфраструктура WPF - коллекция типов, втроенных в сборки .NET. Основные сборки WPF:
```csharp
PresentationCore.dll        Определены многочисленные пространства имен, образующие фундамент уровня графического пользовательского интерфейса в WPF, API WPF Ink, примитивы анимации и типы графической визуализации.
PresentationFramework.dll   Содержит большинство элементво управления WPF, Application & Window, поддержка 2D графики и типы для привязки данных
System.Xaml.dll             Содержит программное взаимодействие с документами XML во время выполнения
WindowsBase.dll             Содержит типы, формирующие инфраструктуру API-интерфейса WPF, типы потоков WPF, типы безопасности, преобразователи типов и поддержку свойств зависимости и маршрутизируемых событий
```
Основные пространства имен WPF:
```csharp
System.Windows              Корневое пространство имен WPF. 
System.Windows.Controls     Содержит все графические элементы WPF, типы для систем меню, подсказки и диспетчеры компоновки
System.Windows.Data         Содержит типы для работы с механизмом привязок данных
System.Windows.Documents    Типы для работы с API-интерфейсом документов в стиле PDF
System.Windows.Ink          Интерфейс Ink API получающий ввод от пера или мыши, реагировать на жесты
System.Windows.Markup       Множество типов, обеспечивающих программный анализ и обработку разметки XAML
System.Windows.Media        Связанные типы мультимедия, анимация, визуализация трехмерной графики, текста, мутлимедийные примитивы
System.Windows.Navigation   Логика навигации браузерных приложений XAML, настольными пиложениями со страничной моделью навигации
System.Windows.Shapes       Типы позволяющие визуализировать 3D графику, реагирующую на ввод мыши
```

Класс System.Windows.Application - глобальный экземпляр выполняющегося приложения WPF с методом Run() для запуска приложения и набором событий для обработки взаимодействия с приложением. Некоторые его свойства:
```csharp
Current                     Статическое свойство получение доступа к работающему объекта Application из любого места кода
MainWindow                  Свойство главного окна приложения
Properities                 Свойство данных, доступных через все аспекты прилжения WPF
StartupUri                  Свойство указывающее окно или страница для автоматического открытия при запуске прложения
WIndows                     Дает объект типа WindowCollection, дающее доступ ко всем окнам, созданным в потоке, создавшем объект Application.
```

Класс System.Windows.Window представляет одиночное окно, которым владеет Application класс.

Класс System.Windows.Controls.ContentControl является родительским для класа Window, срабжающий все производные класса способностью размещать в себе одиночный фрагмент содержимого через свойство Content. Пример кнопки с этим свойстовм:
```csharp
<Button Height="40" Width="80" Content="OK"></Button>
```
Содержимое может быть разным:
```csharp
<Button Height="40" Width="80">
    <StackPanel Orientation="Horizontal">
        <Ellipse Fill="GreenYellow" Height="20" Width="20"></Ellipse>
        <Label Content="OK"></Label>
    </StackPanel>
</Button>
```
Можно применять синтаксис "свойство - элемент" языка XAML:
```csharp
<Button Height="40" Width="80">
    <Button.Content>
        <StackPanel Orientation="Horizontal">
            <Ellipse Fill="GreenYellow" Height="20" Width="20"></Ellipse>
            <Label Content="OK"></Label>
        </StackPanel>
    </Button.Content>
</Button>
```

Класс System.Windows.Controls.Control является базовым для всех элементов управления WPF, снабжая их основной функциональностью пользовательского интерфейса.

Некоторые члены класса Control:
```csharp
Background, Foreground, BorderBrush, BorderTrickness, Padding, HorizontalContentAligment, VerticalContentAligment  Свойства позволяют устанавливать базовые настройки визуализации элементов
FontFamily, FontSize, FontStretch, FontWeight   Свойства управляющие разообразными настройками шритами
IsTabStop, TabIndex             Свойства для установки порядка обхода элементов упралвения по нажатию кнопки <Tab>
MouseDoubleClick, PreviewMouseDoubleClick       События обрабатывают действие двойного делчка на виджете
Template                        Свойство шаблон элемента управления, который может быть использован для изменения вывода визуализации виджета
```

Класс System.Windows.FrameworkElement дает несколько членов применяемых повсюду для раскадровки, привязки данных, именования элементов, получения ресурсов и установки общих измерений производноо типа.

Некоторые члены класса FrameworkElement:
```csharp
ActualHeight, ActualWidth, MaxHeight, MaxWidth, MinHeight, MIn Width, Height, Width     Свойства упраляют размерами производного типа 
ContentMenu                     Свойство получения и устанвки высплывающего меню
Cursor                          Свойство получение и установки курсовра мышки
HorizontalAligment, VertiavalAligment   Свойство управления позиционированием типа внутри контейнера
Name                            Свойство назанчает имя типу, чтоб обращатся к нему в коде
Resource                        Предоставляет доступ к любым ресурсам, определенным типом
ToolTip                         Свойство получения или установки всплывающей подсказки, ассоциированной с производным типом
```

Класс System.Windows.UIElement обеспечивает наибольший объем функциональности, дает производному типу многочисленные события, чтоб мог получать фокус и обрабатывать входные запросы.

Некоторые члены класса FrameworkElement:
```csharp
Focusable, IsFocused            Свойства позволяют устанавливать фокус на заданный тип
IsEnabled                       Свойство управляет доступностью заданного типа
IsMouseDirectlyOver, IsMouseOver Свойства предоставляют простой способ выполнения логики проверки попадания
IsVisible, Visibility           Свойства позволяют работать с настройкой видимости производного типа
RenderTransform                 Свойство позволяет устанавливать трансформацию, используемая при визуализации типа
```

Класс System.Windows.Media.Visual дает поддержку визуализации в WPF.

Класс System.Windows.DependencyObject дает поддержку разновидности свойств - свойств зависимости - в WPF.

Класс System.Windows.Threading.DiapatcherObject дает поддержку очередни событий в WPF, для организации параллелизма и многопоточности.

## Разметка

Корневой элемент разметки почти всегда ссылается на два заранее определенных пространства имен:
```csharp
xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
```
Первое пространство имен XML отображает множество связанных с WPF пространств для использования текущим файлом *.xaml - Windows, Controls, Data, Ink, Media, Navigation.

Второе пространство имен XML служит для добавления специфичных для XAML "ключевых слов".

Помимо ключевых слов x:Name, x:Class, x:Code пространство имен http://schemas.microsoft.com/winfx/2006/xaml предоставляет дополнительно:
```csharp
x:Array                     Предоставляет в XAML массив .NET
x:ClassModifier             Определяет видимость класса C#, обозначенного ключевым словом Class
x:FieldModifier             Определяет видимость члена типа для любого именованноо подэлемента корня, Именованный элемент определяется с ключевым словом Name в XAML
x:Key                       Установка значения ключа элемента, которое будет помещено в словать
x:Name                      Указывание сгенерированное имя C# заданного элемента XAML
x:Null                      Предоставляет ссылку null
x:Static                    Позволяет ссылатся на статический член класса
x:Type                      Эквивалент XAML операции typeof языка C#
x:TypeArguments             Установка элемента как обобщенного типа с определенным параметром типа
```

Для добавления новых элементов из других пространств имен используется синтаксис такой в корневом элементе XML:
```csharp
xmlns:myns="clr-namespace:MyControls;assembly=MyControls" //во внешней сборке
xmlns:myns="clr-namespace:MyNewNamespace" //пространство имен в этой сборке
//элемент:
<myns:MyElement/>
```

По умолчанию все типы C#/XAML являются открытыми, а члены - внутренними. Это можно изменять используя ключевые слова ClassModifier & FieldModifier, пример:
```csharp
<Grid x:ClassModifier="internal">
    <Button Name="myButton" x:FieldModifier="public" Content="OK"></Button>
</Grid>
```

Элементы XAML отображаются на типы классов или структур внутри заданного пространства имен .NET, а атрибуты в открывающем дескрипторе элемента отображаются на свойства или события этого типа. Когда нужно присвоить сложный объект в качестве значения свойства - нужно использовать синтаксис "свойство-элемент".

Пример присвоения сложного свойства через синтаксис "свойство-элемент":
```csharp
<Button Height="40" Width="100" Content="OK" FontSize="20" Foreground="Yellow">
    <Button.Background>
        <LinearGradientBrush StartPoint="1,0" EndPoint="1,1">
            <GradientStop Color="LightGreen" Offset="0"/>
            <GradientStop Color="DarkGreen" Offset="1"/>
        </LinearGradientBrush>
    </Button.Background>
</Button>
```

В XAML поддерживается специальный синтаксис для установки значения присоединяемого свойства, позволяющее дочернему элементу устанавливать значение свойства, которое на самом деле определено в родительском элементе. Пример применения такого свойства зависимости:
```csharp
<Grid>
    <Button Grid.Column="0" Grid.Row="0" Height="40" Width="100" FontSize="20">
        OK
    </Button>
</Grid>
```

Существует еще один способ установки значения атрибута XAML - расширенная разметка. Она позволяет получить значение для свойства из выделенного внешнего класса. Элементы расширенной разметки помещаются между фигурными скобками. Пример расширенной разметки:
```csharp
xmlns:corlib="clr-namespace:System;assembly=mscorlib"
...
<Grid>
    <StackPanel>
        <Label Content="{x:Static corlib:Environment.OSVersion}"></Label>
        <Label Content="{x:Type Button}"></Label>
        <Label Content="{x:Type corlib:Int32}"></Label>
        <ListBox Margin="10">
            <ListBox.ItemsSource>
                <x:Array Type="corlib:String">
                    <corlib:String>Первая строка</corlib:String>
                    <corlib:String>Вторая</corlib:String>
                    <corlib:String>Третья строка</corlib:String>
                </x:Array>
            </ListBox.ItemsSource>
        </ListBox>
    </StackPanel>
</Grid>
```
C помощью XAML можно описывать любой тип из любой сборки при условии, что он является неабстрактным и содержит стандартный конструктор.

## Строительство приложения

Строительство типичного WPF приложения. После создания проекта WPF по умолчанию утанавливаются ссылки на все сборки WPF (PresentationCore.dll, PresentationFramework.dll, System.Xaml.dll и WindowsBase.dll) в XAML файле и файле кода C#.

Элементы WPF можно перетягивать с окна "Панель элементов".

Окно "Свойства" может применяться для конфигурирования пользовательского интерфейса элемента управления WPF.

В окне "Свойства" на вкладке "События" можно управлять событиями выбранного элемента. Хотя события можно создавать и удалять непосредственно в коде XAML.

В окне "Структура документа" можно просматривать все размещенные элементы в окне WPF.

Интерактивный отладчик пользовательского интерфейса облегчает поиск элементов в окне уже выполняемого приложения WPF.

В файле App.xaml посредством разметки определен класс пиложения. Там определены свойства приложения, такие как StartupUri (окно, подлежащее загружке при запуске), ресурсы уровня приложения и специфические обработчики для событий приложения вроде Startup и Exit. Пример разметки и добавленных обработчиков событий запуска приложения и закрытия приложения:

Файл App.xaml & App.xaml.cs:
```csharp
<Application x:Class="WpfApp1.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:WpfApp1"
             StartupUri="MainWindow.xaml"
             Startup="App_OnStartup" Exit="App_OnExit">
    <Application.Resources>
    </Application.Resources>
</Application>
public partial class App : Application
{
    private void App_OnStartup(object sender, StartupEventArgs e)
    {
    }
    private void App_OnExit(object sender, ExitEventArgs e)
    {
    }
}
```

Утилите msbuild.exe при построении приложения для каждого файла XAML создает в проекте три файла: *.g.cs (g - автогенерируемый), *.g.i.cs (i - IntelliSense) и *.baml (BAML - двоичный язык разметки приложений). Эти файлы сохраняются в папке \obj\Debus. 

В первом файле MainWindow.g.cs будет содержатся автоматически созданное определение класса с его элементами и его инициализацией.

А в файле BAML - компактное двоичное представление исходных данных XAML. Он встраивается в виде ресурса в скомпилированную сборку, он встраивается в конечное приложение и при каждом выполенеии приложения он извлекается из контейнера ресурсов и применяется для настройки внешнего вида и поведения всех окон и элементов управления.

В файле App.g.cs содержится автоматически сгенерированный метод Main(), инициализирующий и запускающий приложение. Метод InitializeComponent() конфигурирует свойства приложения, запускаемое окно и обрботчики событий.

В классе Application есть свойство Properties, позволяющее определить коллекцию пар "имя/значение" через индексатор типа System.Object. В эту коллекцию можно сохранять все что угодно с целью последующего извлечения по дружественному имени:
```csharp
Application.Current.Properties["Test"] = true;
if ((bool) Application.Current.Properties["Test"])
    MessageBox.Show("Есть!");
```

Инфраструктура WPF предлагает события для выяснения, действительно ли пользователь намерен закрыть окно. Одно из них - Cloaing в сочетании с делегатом CancelEventHandler, а он предоставляет свойство Cancel, установка оного в true предотвращает закрытие окна. А другое событие - Closed - точка, где окно полностью и безвозвратно готово к закрытию.

Пример применения запроса на подтверждение закрытия окна с данными событиями:
```csharp
public MainWindow()
{
    InitializeComponent();
    this.Closing += MainWindow_Closing;
    this.Closed += MainWindow_Closed;
}
private void MainWindow_Closing(object sender, System.ComponentModel.CancelEventArgs e)
{
    MessageBoxResult result = MessageBox.Show("Действительно закрыть окно?", "Приложение",
        MessageBoxButton.YesNo, MessageBoxImage.Question);
    if (result == MessageBoxResult.No)
        e.Cancel = true; //отмена закрытия окна
}
private void MainWindow_Closed(object sender, EventArgs e)
{
    MessageBox.Show("Пока!");
}
```

Инфраструктура WPF дает несколько событий, помогающих взаимодействоввать с мышью. Определяются связанные с мышью события - MouseMove, MouseUp, MouseDown, MouseEnter, MouseLeave и др. Метод GetPosition() позволяет получать значение (x, y) относительного элемента пользовательского интерфейса в окне.

Пример обработки события MouseMove:
```csharp
public MainWindow()
{
    InitializeComponent();
    this.MouseMove += MainWindow_MouseMove;
}
private void MainWindow_MouseMove(object sender, MouseEventArgs e)
{
    this.Title = e.GetPosition(this).ToString();
}
```

Очень проста обработка клавиатурного ввода окна, на котором находится фокус. Это события - KeyUp, KeyDown, работающие с делегатом System.Windows.Input.KeyEventHandler.

Пример обработки события KeyDown:
```csharp
public MainWindow()
{
    InitializeComponent();
    this.KeyDown += MainWindow_KeyDown;
}
private void MainWindow_KeyDown(object sender, KeyEventArgs e)
{
    this.Title = e.Key.ToString();
}
```


