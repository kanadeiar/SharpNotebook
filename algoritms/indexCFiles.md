# Файлы (последовательная и произвольная работа с файлами)

## Последовательные файлы

В файлы этого типа можно считывать и записывать данные в порядке следования данных.

Открытие файла производится функцией fopen(). 

Указатель на файл объявляется следующим образом:

FILE * f_pointer;

После объявления указателя, его можно ассоциировать с нужным файлом с помощью fopen().

Пример открытия файла:

В файлы этого типа данные можно записывать и считывать в разные участки этого файла. Пример работы с файлом:
```c
FILE *fptr;
int main(int argc, const char* argv[])
{
	SetConsoleCP(1251);
	SetConsoleOutputCP(1251);
	fopen_s(&fptr, "c:\\Temp\\test.txt", "w");
	if (fptr == nullptr)
	{
		printf_s("Не удалось открыть файл!");
     	exit(1);
	}
	fclose(fptr);
```
Если по каким то причинам не удалось открыть файл, то вызов функции возвращает 0.

Строковые модификаторы функции fopen():
```c
"w" - режим записи, создание нового файла, вне зависимости от того, существует он или нет.
"r" - режим чтения, чтение существующего файла, если файл не существует, будет ошибка
"a" - режим добавления (дозаписи) существующего файла или создания нового, если файл не существует
```

Для дозаписи в файл следует использовать функцию fprintf(). Первым в ней аргументом - указатель на файл.

Пример записи в файл некоторых данных:
```c
#define SIZE_BOOKS 3
struct Book
{
	char name[65];
	float price;
	int pages;
};
FILE *fptr;
int main(int argc, const char* argv[])
{
	SetConsoleCP(1251);
	SetConsoleOutputCP(1251);
	Book books[SIZE_BOOKS];
	for (int i = 0; i < SIZE_BOOKS; i++)
	{
		strcpy_s(books[i].name, _countof(books[i].name), "Test");
		books[i].price = 1.1 * i;
		(books + i)->pages = 100 * i;
	}	
	fopen_s(&fptr, "c:\\Temp\\books.txt", "w");
	if (fptr == nullptr)
	{
		printf_s("Не удалось открыть файл!");
		exit(1);
	}
	fputs("Коллекция книг:\n", fptr);
	for (int i = 0; i < SIZE_BOOKS; i++)
	{
		fprintf_s(fptr, "%d: %s\n", (i + 1), (books + i)->name);
		fprintf_s(fptr, "Содержит %d страниц и стоит %.2f\n", books[i].pages, books[i].price);
	}
	fclose(fptr); //всегда закрывать открытые файлы
```

Для чтения информации из файла следует использовать функцию fgets(). Она требует указания длины массива, в который производится считывание данных. При работе с функцией нужно быть бдительным и проверять положение указателя, что он не в конце файла.

Пример чтения строк из записанного ранее файла:
```c
FILE * fptr;
int main(int argc, const char* argv[])
{
	SetConsoleCP(1251);
	SetConsoleOutputCP(1251);
    char line[254]; //хранение вводимых строк
    fopen_s(&fptr, "c:\\Temp\\books.txt", "r");
    if (fptr != 0)
    {
        while (!feof(fptr))
        {
            fgets(line, _countof(line), fptr);
            if (!feof(fptr))
            {
                printf_s(line);
            }
        }
        fclose(fptr);
    }
    else
    {
        puts("Не удалось открыть файл для чтения!");
    }
```

Пример дозаписи строки в файл:

```c
FILE * fptr;
int main(int argc, const char* argv[])
{
	SetConsoleCP(1251);
	SetConsoleOutputCP(1251);
	fopen_s(&fptr, "c:\\Temp\\books.txt", "a");
	if (fptr == 0)
	{
		printf_s("Не удалось открыть файл!");
		exit(1);
	}
	fputs("Нужно больше книг!:\n", fptr);
	fclose(fptr); //всегда закрывать открытые файлы
```
Нельзя производить чтение файла без использования функции feof(), так как возможно, уже прочитана последняя строка файла.

## Файлы произвольного доступа

Физическое размещение файла не определяет его тип. Можно создать файл последовательно, а затем читать и изменять его произвольно.

Чтобы читать и записывать в файл произвольно, нужно открыть его в режиме произвольного доступа.

Строковые модификаторы функции fopen():
```c
"w+" - открывает новый файл для чтения и записи
"r+" - открывает существующий файл для чтения и записи
"a+" - открывает файл в дозаписи, но позволяет вернуться назад по тексту и совершить чтение или запись по мере необходимости
```

Для переещения по файлу следует использовать функцию fseek(). Функция эта смещает указатель по фалу таким образом, что для записи и чтения становятся доступны те участки файла, которые были недоступными при последовательном доступе.

Формат функции:

fseek(pFile, longVal, начало)

указатель на файл (в произвольном режиме), количество байтов, которые нужно пропустить (вперед или назад) при перемещении по файлу, последний аргумент - это одно из значений, сообщающее откуда нужно начинать поиск нужно фрагмента функцией fseek().
```c
начало          описание
SEEK_SET        начало файла
SEEK_CUR        текущая позиция в файле
SEEK_END        конец файла
```
Если установить указатель на конец файла SEEK_END и начать записывать, то новые данные будут добавлены в конец файла. Если иначе - то новые данные затрут уже имеющиеся.

Пример работы с файлом в режиме произвольного доступа - запись и чтение:
```c
FILE * fptr;
int main(int argc, const char* argv[])
{
	SetConsoleCP(1251);
	SetConsoleOutputCP(1251);
	fopen_s(&fptr, "c:\\Temp\\letters.txt", "w+");
	if (fptr == 0)
	{
		puts("Произошла ошибка при открытии файла.");
		exit(1);
	}
	for (char lett = 'A'; lett <= 'Z'; lett++)
	{
		fputc(lett, fptr);
	}
	puts("Данные в файл записаны");
	puts("Данные из файла в обратной последовательности:");
	fseek(fptr, -1, SEEK_END);
	for (int i = 26; i > 0; i--)
	{
		printf_s("Буква - %c\n", fgetc(fptr));
		fseek(fptr, -2, SEEK_CUR);
	}
	fclose(fptr);
```
Пример работы с файлом в режиме произвольного доступа - изменение файла:
```c
FILE * fptr;
int main(int argc, const char* argv[])
{
	SetConsoleCP(1251);
	SetConsoleOutputCP(1251);
	fopen_s(&fptr, "c:\\Temp\\letters.txt", "r+");
	if (fptr == 0)
	{
		puts("Произошла ошибка при открытии файла.");
		exit(1);
	}
	printf_s("Какую букву заменить? (1-26)?:> ");
	int pos;
	scanf_s(" %d", &pos);
	fseek(fptr, pos - 1, SEEK_SET);
	fputc('*', fptr); //замена символа на другой
	fseek(fptr, 0, SEEK_SET);
	puts("Измененный файл:");
	for (int i = 0; i < 26; i++)
	{
		printf_s("Буква - %c\n", fgetc(fptr));
	}
	fclose(fptr);
```

