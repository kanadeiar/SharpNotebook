# Команды CLI EF Core

Глобальный инструмент командной строки CLI EF Core под названием dotnet-ef содержит команды, необходимые для создания шаблонов существующих баз данных в коде, для создания/удаления миграций баз данных и для работы с базой данных.

Команда установки инструмента глобально:

```csharp
dotnet tool install --global dotnet-ef --version 6.0.0
```

Команда удаления инструмента:

```csharp
dotnet tool uninstall --global dotnet-ef
```

Страница приветствия инструмента:

```csharp
dotnet ef
```

## Команды

Основные команды глобального инструмента:

database - Подкоманды этой команды предназначены для управления базой данных и включают drop и update.

dbcontext - Подкоманды этой команды служат для управленя типами dbcontext и включают scaffold, list, info.

migrations - Подкоманды этой команды предназначены для управления миграцими базы данных и включают add, list, remove, script.

Команды выполняются в отношении файлов проекта и целевой проект должен ссылаться на пакет NuGet Microsoft.EntityFrameworkCore.Design. Команды работают с тем проектом, где команды вводятся или определенным через параметры.

Команды работают с экземпляром, производным от DbContext, при наличии только одного в проекте. Если их несколько - нужно уточнить какой именно использовать. Лучший вариант - всегда создавать реализацию интерфейса IDesignTimeDbContextFactory<TContext> для каждого класса, производного от DbContext.

## Параметры команд EF Core

-с <класс, производный от DbContext> - Полностью заданное имя производного от DbContext класса, который должен использоваться.

-p - Проект, подлежащий использованию

-s - Стартовый проект, подлежащий использованию

-h - Справочная информация и все параметры

-v - Многословный вывод

## Команды управления миграциями

Команды migrations используются для добавления, удаления, перечисления и создания сценариев миграций.

### Команда add

Создает новую миграцию базы данных, основываямь на текущей объектной модели. Исследуются все сущности в свойствах DbSet<T> в производном от DbContext классе. При наличии изменений генерируется надлежащий код обновления базы данных.

Для каждой миграции создаются два файла. Первый файл содержит код, сгенерированный для изменений базы данных в этой миграции, а второй файл - код, который предназначен для создания и обновления базы данных на основе всех миграций до этой включительно.

Первый файл содержит два метода, Up() (код для обновления базы данных с учетом изменений этой миграции) и Down() (код для отката изменений этой миграции). 

Производный от DbContext класс может помечать сущность как исключенную из миграций, позволяя другому DbContext становится системой записи для данной сущности.

Пример исключения сущности:

```csharp
modelBuilder.Entity<BaseEntity>().ToTable("BaseEntities", t => t.ExcludeFromMigrations());
```

### Команда remove

Применяется для удаления миграций из проекта и всегда работает с последней миграцией. Если миграция удаляемая была применена, то процесс удаления потерпит неудачу. Если миграция не применена или была подвергнута откату, то она удаляется, а файл моментального снимка обновляется.

### Команда list

Позволяет получить все миграции для класса, производного от DbContext.

### Команда bundle

Команда позволяет создать испольняемый файл для обновления базы данных.

### Команда script

Создает сценарий SQL на основе одной или большего количества миграций.

## Команды управления базой данных

Команды удаляют базы данных, если она существует и обновляют базу данных с помощью миграций.

### Команда drop

Удаляет базу данных, указанную в строке подключения.

### Команда update

Обновляет базу данных до самой последней миграции, при необходимости создавая базу данных. Если указано имя миграции, то база данных обновляется до этой миграции. Если имя миграции имеет отметку времени болюю раннюю, чем примененные миграции, то выполняется откат миграций. Если указать в качестве имени миграции 0, то будет произведен откат всех миграций.

## Команды управления типами DbContext

Команды позволяют производить различные манипуляции с типами, производными от DbContext.

info - получить информацию о производном от DbContext типе

list - получить список доступных DbContext типов

script - генерация сценария SQL на основе объектной модели DbContext, пропуская любые миграции 

### Команда scaffold

Создает из существующей базы данных классы C# - DbContext, с командами Fluent API + сущности, дополненные аннотациями данных.

У команды два обязательных параметра - строка подключения к базе данных и полностью заданный поставщик (например, Microsoft.EntityFrameworkCore.SqlServer).

Дополнительные параметры команды позволяют настроить процесс создания классов.

-d - Использовать для конфигурирования аттрибуты (аннотации данных) где это возможно.

-с <имя> - Имя подлежащего созданию класса, производного от DbContext

--context-dir <путь> - Каталог, куда должен быть помещен файл класса, производного от DbContext

-f - Заменять файлы, существующие в целевом каталоге

-о <путь> - Каталог, куда должны быть помещены генерируемые файлы сущностных классов

--schema <имя схемы> - Схемы таблиц, для которых должны генерироваться сущностные классы

-t <имя таблицы> - Таблицы, для которых должны генерироватся сущностные классы

--use-database-names - Использовать имена таблиц и столбцов прямо из базы данных

-n <пространство имен> - Пространство имен для генерируемых сущностных классов

--context-namespace <пространство имен> - Пространство имен для генерируемого класса, производного от DbContext

--no-onconfiguring - Не генерировать метод OnConfiguring()

--no-pluralize - Не использовать средство перевода имен в множественное число

### Команда optimize

Оптимизирует класс, произвоный от DbContext. Создает скомпилированную версию моделей, которые уже использует производный от DbContext класс.

Скомпилированне модели повышают производительность работы EF Core.

Результаты компиляции включают класс для сущностей, скомпилированный от DbContext класс + скомпилированный ModelBuilder.

Чтобы использовать скомпилированную модель, нужно вызвать метод UseModel() в DbContextOptions.

Пример:

```csharp
optionsBuilder.UseSqlServer(connectionString).UseModel(ApplicationDbContextModel.Instance);
```

У скомпилированных моделей есть несколько ограничений:

- Глобальные фильтры запросов не поддерживаются

- Ленивая загрузка прокси не поддерживается

- Прокси-серверы отслеживания изменений не поддерживаются

- Модель должна быть перекомпилирована каждый раз, когда изменяется

