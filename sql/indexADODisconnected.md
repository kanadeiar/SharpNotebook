# Автономный уровень ADO.NET

Автономный уровень позволяет моделировать данные из базы данных в памяти, внутри вызывающего кода, применением членов из пространства имен System.Data. Применением автономного уровня можно моделировать реляционные данные в памяти, включая табличные блоки строк и столбцов, отношения между таблицами, ограничения столбцов, первичные ключи, представления и прочее. К смоделированным данным можно применять фильтры, отправлять запросы в память и сохранять/загружать данные в формате XML и в двоичном формате.

Для выборки и обновления данных в базе данных нужно задействовать объект - адаптер данных (абстрактный класс DbDataAdapter). Объекты адаптера перемещают данные из вызывающего кода и источника данных с примененением объектов DataSet. Последний - это контейнер для любого количества объектов DataTable - этот объект содержит колекцию объектов DataColumn и DataRow. Адаптеры данных удерживают подключение открытым в течении минимально возможного времени. Физическая база данных не обновляется, пока не будет передат объект DataTable из DataSet адаптеру даных для обновления.

## Контейнер объектов базы данных DataSet

Этот объект содержит в себе коллекцию таблиц - свойство Tables. Можно программироваь отношения "родительский - дочерний" между таблицами, ограничение внешнего ключа через свойство Relations. А свойство ExtendedProperities позволяет создавать дополнительную информацию в виде пар "имя-значение".

Некоторые свойства DataSet:

Свойство                 | Описание
-------------------------|-------------------------
CaseSensitive            | Установка, что будет/нет чуствительно к регистру сравнение строк - по умолчанию false
DataSetName              | Дружественное имя объекта DataSet
EnforceConstrains        | Установка - соблюдаются ли правила ограничений при попытке выполнить любые операции обновления
HasErrors                | Получение значения что есть ошибки в любой строке любого объекта DataTable внутри DataSet
RemotingFormat           | Определение, каким образом DataSet должен сериализовать свое содержимое - в двоичном виде или XML

Некоторые методы DataSet:

Методы                   | Описание
-------------------------|-------------------------
AcceptChanges()          | Фиксирует все изменения, внесенные в текущий DataSet с момента его загрузки или последнего вызова AcceptChanges()
Clear()                  | Очищает данные DataSet, удаляя каждую строку из каждого DataTable
Clone()                  | Клонирует структуру, но не данные, включая каждую таблицу DataTable, отношение, ограничения
Copy()                   | Копирует структуру и данные
GetChanges()             | Копия, содержащая все изменения, внесенные в объект с момета загрузки или последнего фиксирования изменений. Можно получить тольно новые строки, только измененные строки или только удаленные строки.
HasChages()              | Значение, что объект был изменен, добавлены, изменены или удалены данные
Merge()                  | Объединяет текущий объект с указанным
ReadXml()                | Определение структуры объекта DataSet и заполнение его данными, основываясь на XML схеме данных из потока
RejectChanges()          | Откат всех изменений, внесенные в объект с момента загрузки или последнего фиксирования изменений.
WriteXml()               | Запись содержимого объекта DataSet в действитльный поток

Пример работы с DataSet:
```csharp
DataSet dataSet = new DataSet("Sample");
dataSet.ExtendedProperties["TimeStamp"] = DateTime.Now; //время создания
dataSet.ExtendedProperties["DataSetId"] = Guid.NewGuid(); //уникальный идентификтор
dataSet.ExtendedProperties["Company"] = "Пример";
```

## Одиночный столбец DataColumn

Одиночный столбец внутри таблицы DataTable. На каждый столбец можно установить набор ограничений. Каждый столбец должен отображать лежащий в основе тип данных.

Столбец можно сделать автоинкрементированным. Значение такого столбца будет устанавливаться автоматически на основе предидущего значения.

Некоторые свойства DataColumn:

Свойство                | Описание
------------------------|-------------------------
AllowDBNull             | Указание, что столбец может содержать значения null
AutoIncrement, AutoIncrementSeed, AutoIncrementStep | Настройка поведения автоинкремента для заданного столбца. Полезно в случаях, когда нужно гарантировать уникальность значений.
Caption                 | Заголовок, отображаемый для столбца, дружественное имя для пользователя
ColumnMapping           | Представление объекта DataColumn при сохранении DataSet в документе XML. Возможное - записывание как элемента XML, атрибут XML, простое текстовое содержимое или игнорироваться
ColumnName              | Имя столбца в коллекции Columns объекта DataTable, стандартное значение - Coumn1, Column2, Column3 и т.д.
DataType                | Тип данных, хранящихся в столбце
DefaultValue            | Стандартное значение, присваиваемое при вставке новых строк
Expression              | Выражение для фильтрации строк, вычисления значения столбца или агрегированного столбца
Ordinal                 | Числовая позиция столбца в коллекции Colums объекта DataTable
ReadOnly                | Установка, что столбец доступен только для чтения, после добавления строки в таблицу, стандарт - false
Table                   | Вертает объект DataTable, содержащий текущий объект DataColumn
Unique                  | Значение, указывающее, должны ли значения этого столбца быть уникальными или разрешены одинаковые значения. При установке столбцу ограничения первичного ключа, это свойство должно быть true

Пример работы с DataColumn:
```csharp
var personIdColumn = new DataColumn("Id", typeof(int))
{
    Caption = "Id №",
    ReadOnly = true,
    AllowDBNull = false,
    Unique = true,
    AutoIncrement = true, //автоинкремент
    AutoIncrementSeed = 1,
    AutoIncrementStep = 1,
};
var personFamColumn = new DataColumn("Fam", typeof(string));
var personNameColumn = new DataColumn("Name", typeof(string));
var personAgeColumn = new DataColumn("Age", typeof(int));
var personTable = new DataTable("Person");
personTable.Columns.AddRange(new[] {personIdColumn, personFamColumn, personNameColumn, personAgeColumn});
```

## Строка данных DataRow

Представляет собой объект-строку данных таблицы DataTable. Создавать экземпляр DataRow напрямую невозможно, открытый конструктор отсутствует. Новый объект получается из объекта DataTable. После получения каждый столбец строки можно заполнять новыми данными через индексатор по имени или по номеру.

Некоторые члены DataRow:

Свойство                | Описание
------------------------|-------------------------
HasErrors, GetColumnInError(), GetColumnError(), ClearError(), RowError | 









Код SQL генерации тестовой базы данных:
```csharp
CREATE TABLE [dbo].[Person] (
    [Id]   INT           IDENTITY (1, 1) NOT NULL,
    [Fam]  NVARCHAR (64) NOT NULL,
    [Name] NVARCHAR (64) NOT NULL,
    [Age]  INT           NOT NULL,
    CONSTRAINT [PK_Id_Person] PRIMARY KEY CLUSTERED ([Id] ASC)
);
CREATE TABLE [dbo].[Child] (
    [Id]       INT          IDENTITY (1, 1) NOT NULL,
    [Fam]      NVARCHAR (64) NOT NULL,
    [Name]     NVARCHAR (64) NOT NULL,
	[Age] INT NOT NULL,
    [PersonId] INT          NOT NULL,
    CONSTRAINT [PK_Id_Child] PRIMARY KEY CLUSTERED ([Id] ASC),
    CONSTRAINT [FK_Child_To_Person] FOREIGN KEY ([PersonId]) REFERENCES [dbo].[Person] ([Id])
);

INSERT INTO Person([Fam], [Name], [Age])
VALUES (N'Иванов', N'Иван', 20),
(N'Петров', N'Петр', 22),
(N'Сидоров', N'Сидор', 18);
INSERT INTO Child([Fam], [Name], [Age], [PersonId])
VALUES (N'Михаилов', N'Михаил', 3, 1),
(N'Навозов', N'Дмитрий', 13, 1),
(N'Логинов', N'Логин', 3, 2);
```










