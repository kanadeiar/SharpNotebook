# Введние ADO.NET

Существует три разных способа применения ADO.NET:

1. Подключенный уровень - кодовая база подключается к лежащему в основе храниищу данных и отключается от него, взаимодействие с хранилищем данных посредством подключений, объектов команд и объектов чтения данных.

2. Автономный уровень - манипулированием объектов DataTable (он внутри DataSet) как копией внешних данных. А уже для отправки изменения в хранилище данных применяется адаптер данных.

3. Применение ORM, такой как Entity Framework. Применение объектов C#, предоставляющие данные в ориентированной на приложение манере. Абстрагирование от кода доступа к данным. Взаимодействие с базами данных с использованием строго типизированных запросов LINQ.

Поставщик данных - набор типов, определенных в отдельном пространстве имен, которым известно, как взаимодействовать с конкретным источником данных. Все основные классы являются производными от самого базового класса DbConnection, реализуют идентичные интерфейсы IDBConnection.

Некоторые типы поставщиков данных ADO.NET:

Тип         | Базовый класс | Интерфейсы     | Описание  
------------|---------------|----------------|------------
Connection  | DbConnection  | IDbConnection  | Отключение и подключение к хранилищу данных, доступ к связанной транзакции
Command     | DbCommand     | IDbCommand     | Запрос SQL либо хранимая процедура, доступ к объекту чтения данных поставщика
DataReader  | DbDataReader  | IDbDataReader IDbDataRecord | Доступ к данным в направлении вперед для чтения с использованием SQL курсора
DataAdapter | DbDataAdapter | IDataAdapter IDbDataAdapter | Передача объектов DataSet между кодом и хранилищем данных, содержит подключение и команды выборки, вставки, изменения и удаления данных
Parameter   | DbParameter   | IDataParameter IDbParameter | Именованный параметр параметризированного запроса
Transaction | DbTransaction | IDbTransaction | Именованный параметр параметризированного запроса

## Примитивы базы данных

Пространство имен System.Data содержит различные примитивы базы данных, реализуемые поставщиками данных.

Тип         | Описание
------------|---------------
Constraint  | Ограничение для заданного объекта DataColumn
DataColumn  | Одиночный столбец объекта DataTable
DataRelation | Отношение "родительский-дочерний" между двумя объектами DataTable
DataRow     | Одиночная строка объекта DataTable
DataSet     | Находящийся в памяти кеш данных, сотоящий из любого количества взаимосвязанных объектов DataTable
DataTable   | Табличный блок данных в памяти
DataTableReader | Трактовка объекта DataTable как курсор чтения данных в одном направлении
DataView  | Настраиваемое представление для сортировки, фильтрации, поиска, редактирования и навигации
IDataAdapter | Поведение объекта адаптера данных
IDataParameter  | Поведение объекта параметра
IDataReader  | Поведение объекта чтения данных
IDbCommand  | ПОведение команды
IDbDataAdapter | Расширяет интерфейс IDataAdapter в целях дополнительной функциональности
IDbTransaction | Поведение объекта транзакции

>метод IsDBNull(int i) позволяет определить, установлено ли указанное поле в null. 

## Подключение к базе данных

Пример обычной строки подключения:

```csharp
string connectionString = @"data source = DESKTOP-Q5PLE8H\SQLEXPRESS; Initial Catalog = Lesson7; Integrated Security = True; Connect Timeout = 3";
```
Параметры строки получения:

- Application Name: название приложения. Может принимать в качестве значения любую строку. Значение по умолчанию: ".Net SqlClient Data Provide"

- AttachDBFileName: хранит полный путь к прикрепляемой базе данных

- Connect Timeout: временной период в секундах, через который ожидается установка подключения. Принимает одно из значений из интервала 0–32767. По умолчанию равно 15.

В качестве альтернативного названия параметра может использоваться Connection Timeout

- Data Source: название экземпляра SQL Servera, с которым будет идти взаимодействие. Это может быть название локального сервера, например, "EUGENEPC/SQLEXPRESS", либо сетевой адрес.

В качестве альтернативного названия параметра можно использовать Server, Address, Addr и NetworkAddress

- Encrypt: устанавливает шифрование SSL при подключении. Может принимать значения true, false, yes и no. По умолчанию значение false
- Initial Catalog: хранит имя базы данных

В качестве альтернативного названия параметра можно использовать Database

- Integrated Security: задает режим аутентификации. Может принимать значения true, false, yes, no и sspi. По умолчанию значение false

В качестве альтернативного названия параметра может использоваться Trusted_Connection

- Packet Size: размер сетевого пакета в байтах. Может принимать значение, которое кратно 512. По умолчанию равно 8192

- Persist Security Info: указывает, должна ли конфиденциальная информация передаваться обратно при подключении. Может принимать значения true, false, yes и no. По умолчанию значение false

- Workstation ID: указывает на рабочую станцию - имя локального компьютера, на котором запущен SQL Server

- Password: пароль пользователя

- User ID: логин пользователя

- ExecuteNonQuery() - возвращает число обработанных строк, или -1 если ни одна строка не обработана.

Альтернативно можно использовать построитель строки подключения:
```csharp
var connectionStringBuilder = new SqlConnectionStringBuilder
{
    DataSource = @"(localdb)\MSSQLLocalDB",
    InitialCatalog = "demo",
    Pooling = true,
    IntegratedSecurity = true,
};
```

## Фабрика поставщика данных

Модель фабрики поставщиков данных .NET DbProviderFactory позволяет строить единую кодовую базу на основе обобщенных типов доступа к данным.

Пример получения определенного поставщика данных SQL:
```csharp
DbProviderFactory sqlFactory = DbProviderFactories.GetFactory("System.Data.SqlClient");
```
Пример применения фабрики поставщика данных:
```csharp

```


## Отслеживание изменения состояния соеднинения

В объекте соединения существует событие, позволяющее отслеживать изменение состояния соеднения. Пример:
```csharp
            connection.StateChange += Connection_StateChange;
            connection.Open();
...
private static void Connection_StateChange(object sender, System.Data.StateChangeEventArgs e)
{
    var s = sender as SqlConnection;
    Console.WriteLine($"Сбор статистики: {s.StatisticsEnabled} имя источника: {s.DataSource} новое состояние: {e.CurrentState} текущее состояние: {e.OriginalState}");
}
```

